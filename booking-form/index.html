<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Kendaraan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #ff0000, #ffffff);
      margin: 0; padding: 0; min-height: 100vh;
    }
    .container {
      max-width: 700px; margin: 50px auto;
      background: white; padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2, h3 { text-align: center; color: #b30000; }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; display: block; }
    input, select, textarea {
      width: 100%; padding: 10px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button {
      padding: 10px 20px; border: none; border-radius: 5px;
      background-color: #b30000; color: white;
      cursor: pointer; font-size: 1rem;
      margin: 5px 0; transition: background 0.2s;
    }
    button:hover { background-color: #800000; }
    .hidden { display: none !important; }
    .dashboard-menu {
      display: flex; flex-wrap: wrap;
      justify-content: center; gap: 30px;
      margin: 40px 0;
    }
    .card-btn {
      background: #fff; border: 2px solid #b30000;
      color: #b30000; border-radius: 10px;
      padding: 30px 40px; font-size: 1.2rem;
      font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer; transition: all 0.2s;
    }
    .card-btn:hover {
      background: #b30000; color: #fff;
      transform: translateY(-3px) scale(1.03);
    }
    .logout-btn {
      float: right;
      background: #ccc;
      color: #b30000;
      font-weight: bold;
      margin-top: -20px;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc; padding: 8px;
      text-align: left;
    }
    th { background-color: #f2f2f2; }
    .table-responsive {
      width: 100%;
      overflow-x: auto;
    }
    @media (max-width: 600px) {
      .container { padding: 10px; }
      .dashboard-menu { flex-direction: column; gap: 15px; }
      .card-btn { width: 100%; padding: 20px 0; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- LOGIN -->
  <div id="loginPage">
    <h2>Login Admin</h2>
    <form id="loginForm">
      <div class="form-group"><label>Email</label><input type="text" name="username" required></div>
      <div class="form-group"><label>Password</label><input type="password" name="password" required></div>
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardPage" class="hidden">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h2>Dashboard</h2>
    <div class="dashboard-menu">
      <button class="card-btn" onclick="showNewBookingForm()">Booking Kendaraan</button>
      <button class="card-btn" onclick="showPage('dataPage')">Data Booking</button>
    </div>
  </div>

  <!-- FORM BOOKING -->
  <div id="bookingPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>Form Booking</h3>
    <form id="bookingForm">
      <input type="hidden" name="editId" id="editId" />
      <input type="hidden" name="sheetName" id="sheetName" />
      <div class="form-group"><label>Nomor Polisi</label><input type="text" name="plat" required /></div>
      <div class="form-group hidden" id="statusGroup">
        <label>Status Kehadiran</label>
        <select name="status_kehadiran" id="status_kehadiran_select">
          <option value="show">show</option>
          <option value="no show">no show</option>
          <option value="reschedule">reschedule</option>
        </select>
      </div>
      <div class="form-group"><label>Tipe Kendaraan</label><input type="text" name="tipe" required /></div>
      <div class="form-group"><label>Tahun</label><input type="text" name="tahun" required /></div>
      <div class="form-group"><label>No HP</label><input type="text" name="nohp" required /></div>
      <div class="form-group"><label>Customer Akan Datang</label><input type="text" name="datang" required /></div>
      <div class="form-group"><label>Nama Customer</label><input type="text" name="nama" required /></div>
      <div class="form-group"><label>Tanggal Penerimaan</label><input type="date" name="tanggal_penerimaan" required /></div>
      <div class="form-group"><label>Jam Penerimaan</label><input type="time" name="jam_penerimaan" required /></div>
      <div class="form-group"><label>VIA</label>
        <select name="via" required>
          <option value="AW">AW</option>
          <option value="SA">SA</option>
          <option value="TAB">TAB</option>
          <option value="MRS">MRS</option>
          <option value="TLP">TLP</option>
        </select>
      </div>
      <div class="form-group"><label>Admin</label>
        <select name="admin" required>
          <option value="Frenty">Frenty</option>
          <option value="Risa">Risa</option>
          <option value="AW">AW</option>
        </select>
      </div>
      <div class="form-group"><label>Jenis Pekerjaan</label><textarea name="keluhan" required></textarea></div>
      <div class="form-group"><label>Nama Sales (Opsional)</label><input type="text" name="sales" /></div>
      <button type="submit" id="submitBtn">Kirim</button>
    </form>
  </div>

  <!-- DATA -->
  <div id="dataPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>Data Booking</h3>
    <div>
      <label>Filter Tanggal: <input type="date" id="filter-date" /></label>
      <button onclick="loadData()">Lihat Data</button>
    </div>
    <div class="table-responsive">
      <table id="dataTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Status</th>
            <th>Plat</th>
            <th>Tipe</th>
            <th>Tahun</th>
            <th>HP</th>
            <th>Datang</th>
            <th>Nama</th>
            <th>Tanggal Booking</th>
            <th>Tanggal Penerimaan</th>
            <th>Jam Penerimaan</th>
            <th>Via</th>
            <th>Admin</th>
            <th>Keluhan</th>
            <th>Sales</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwRCWOgF3_GALok4A1flT4ks8rMXj7v_-zpZBj5c17fKW7xN4GVAJnMKglWYpTNL9Pn/exec";

function formatDateOnly(dateStr) {
  if (!dateStr) return "";
  if (dateStr instanceof Date) return dateStr.toISOString().split("T")[0];
  if (typeof dateStr === "string" && dateStr.includes("T")) return dateStr.split("T")[0];
  if (typeof dateStr === "string") return dateStr;
  return "";
}

function formatJam(jamStr) {
  if (!jamStr) return "";
  // Jika format sudah HH:mm, langsung return
  if (/^\d{1,2}:\d{2}$/.test(jamStr)) return jamStr;
  // Jika format ISO, ambil jam dan menit
  const date = new Date(jamStr);
  if (isNaN(date.getTime())) return jamStr;
  let hours = date.getHours();
  const minutes = date.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12; // 0 jadi 12
  return `${hours}:${minutes} ${ampm}`;
}

function showPage(id) {
  ["loginPage", "dashboardPage", "bookingPage", "dataPage"].forEach(p => document.getElementById(p).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function checkLogin() {
  if (localStorage.getItem("isLoggedIn") === "true") {
    showPage("dashboardPage");
  } else {
    showPage("loginPage");
  }
}

function logout() {
  localStorage.removeItem("isLoggedIn");
  checkLogin();
}

document.getElementById("loginForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const username = e.target.username.value.trim();
  const password = e.target.password.value.trim();
  if (username === "agmeylanecha@gmail.com" && password === "saturjeff") {
    localStorage.setItem("isLoggedIn", "true");
    showPage("dashboardPage");
    e.target.reset();
  } else {
    alert("Email atau password salah!");
  }
});

document.getElementById("bookingForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const params = new URLSearchParams();
  formData.forEach((v, k) => params.append(k, v));

  // Cek apakah ini edit atau tambah baru
  const isEdit = form.editId.value !== "";
  if (isEdit) {
    params.append("id_row", form.editId.value);
    params.append("sheetName", form.sheetName.value);
    params.append("action", "edit");
    // Tambahkan status hanya saat edit
    params.append("status_kehadiran", document.getElementById("status_kehadiran_select").value);
  }

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      if (isEdit) {
        // Jika edit, kembali ke halaman data dan refresh
        document.getElementById("editId").value = "";
        document.getElementById("sheetName").value = "";
        showPage("dataPage");
        loadData();
      } else {
        // Jika tambah baru, reset form dan tetap di halaman booking
        form.reset();
      }
    })
    .catch(err => {
      alert("Gagal menyimpan data: " + err);
    });
});

function loadData() {
  const tanggal = document.getElementById("filter-date").value;
  if (!tanggal) return alert("Pilih tanggal dulu!");

  fetch(`${URL}?tanggal_penerimaan=${tanggal}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='15'>Tidak ada data</td></tr>";
        document.getElementById("dataTable").classList.remove("hidden");
        return;
      }

      data.forEach((row, idx) => {
        // Penyesuaian field sesuai header
        const tds = `
          <td>${idx + 1}</td>
          <td>${row.status_kehadiran || ""}</td>
          <td>${row.nomor_polisi || row.plat || ""}</td>
          <td>${row.tipe_kendaraan || row.tipe || ""}</td>
          <td>${row.tahun || ""}</td>
          <td>${row.no_hp || row.nohp || ""}</td>
          <td>${row.customer_akan_datang || row.datang || ""}</td>
          <td>${row.nama_customer || row.nama || ""}</td>
          <td>${formatDateOnly(row.tanggal_booking)}</td>
          <td>${formatDateOnly(row.tanggal_penerimaan)}</td>
          <td>${formatJam(row.jam_penerimaan || "")}</td>
          <td>${row.via || ""}</td>
          <td>${row.admin || ""}</td>
          <td>${row.jenis_pekerjaan || row.keluhan || ""}</td>
          <td>${row.nama_sales || row.sales || ""}</td>
          <td>
            <button onclick='editRow(${JSON.stringify(row)})'>Edit</button>
            <button onclick='deleteRow("${row.id_row}", "${row.tanggal_penerimaan}", "${row.sheetName}", this)'>Hapus</button>
          </td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });

      document.getElementById("dataTable").classList.remove("hidden");
    })
    .catch(err => {
      alert("Gagal memuat data: " + err);
    });
}


function showNewBookingForm() {
  showPage("bookingPage");
  const form = document.getElementById("bookingForm");
  form.reset();
  document.getElementById("editId").value = "";
  document.getElementById("sheetName").value = "";
  document.getElementById("submitBtn").textContent = "Kirim";
  document.getElementById("statusGroup").classList.add("hidden");
}

function editRow(row) {
  showPage("bookingPage");
  const form = document.getElementById("bookingForm");
  form.plat.value = row.nomor_polisi || "";
  document.getElementById("statusGroup").classList.remove("hidden");
  document.getElementById("status_kehadiran_select").value = row.status_kehadiran || "show";
  form.tipe.value = row.tipe_kendaraan || "";
  form.tahun.value = row.tahun || "";
  form.nohp.value = row.no_hp || "";
  form.datang.value = row.customer_akan_datang || "";
  form.nama.value = row.nama_customer || "";
  form.tanggal_penerimaan.value = row.tanggal_penerimaan || "";
  form.jam_penerimaan.value = row.jam_penerimaan || "";
  form.via.value = row.via || "";
  form.admin.value = row.admin || "";
  form.keluhan.value = row.jenis_pekerjaan || "";
  form.sales.value = row.nama_sales || "";

  document.getElementById("editId").value = row.id_row;
  document.getElementById("sheetName").value = row.sheetName;
  document.getElementById("submitBtn").textContent = "Update Data";
}


function deleteRow(id_row, tanggal, sheetName, btn) {
  if (!confirm("Yakin ingin hapus data ini?")) return;
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Menghapus...";
  }
  const params = new URLSearchParams();
  params.append("id_row", id_row);
  params.append("tanggal_penerimaan", tanggal);
  params.append("sheetName", sheetName);
  params.append("action", "delete");

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      loadData();
    })
    .catch(err => {
      alert("Gagal menghapus data: " + err);
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Hapus";
      }
    });
}



window.onload = checkLogin;
</script>
</body>
</html>